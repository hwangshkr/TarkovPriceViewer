name: .NET Desktop

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      RELEASE_TAG: ${{ steps.version.outputs.RELEASE_TAG }}
      IS_PRERELEASE: ${{ steps.version.outputs.IS_PRERELEASE }}

    steps:
    - name: Checkout
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Compute tag from project version
      id: version
      run: |
        BRANCH="${GITHUB_REF_NAME}"

        # Read project version from csproj (bare semver, possibly with pre-release suffix)
        PROJECT_VERSION=$(grep -oP '(?<=<Version>)[^<]+' TarkovPriceViewer.csproj)

        if [[ -z "$PROJECT_VERSION" ]]; then
          echo " Error: Could not read <Version> from TarkovPriceViewer.csproj"
          exit 1
        fi

        echo "Project version from csproj: $PROJECT_VERSION"

        # Build tag name from project version
        TAG="v${PROJECT_VERSION}"

        # Determine if tag is pre-release (has a '-' suffix) or stable
        if [[ "$PROJECT_VERSION" == *-* ]]; then
          IS_PRERELEASE="true"

          # Pre-release versions must NOT be built from main
          if [[ "$BRANCH" == "main" ]]; then
            echo " Error: Main branch can only release stable versions (no pre-release suffix). Current Version is '$PROJECT_VERSION'"
            exit 1
          fi

          echo " Pre-release build detected for branch '$BRANCH'. Tag to create: $TAG"
        else
          IS_PRERELEASE="false"

          # Stable versions must be built from main
          if [[ "$BRANCH" != "main" ]]; then
            echo " Error: Non-main branches must use pre-release versions (with a suffix like -beta.1). Current Version is '$PROJECT_VERSION'"
            exit 1
          fi

          echo " Stable build detected on main. Tag to create: $TAG"
        fi

        echo "RELEASE_TAG=$TAG" >> $GITHUB_OUTPUT
        echo "IS_PRERELEASE=$IS_PRERELEASE" >> $GITHUB_OUTPUT

    - name: Install .NET Core
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: 10.0.x

    - name: Restore dependencies
      run: dotnet restore

    - name: Publish
      run: dotnet publish

    - name: Upload build artifacts
      uses: actions/upload-artifact@v5
      with:
        name: TarkovPriceViewer-win-x64
        path: ./publish

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v6
      with:
        name: TarkovPriceViewer-win-x64
        path: ./release-assets

    - name: Build release notes
      id: notes
      uses: actions/github-script@v7
      with:
        result-encoding: string
        script: |
          const { owner, repo } = context.repo;
          const tagName = '${{ needs.build.outputs.RELEASE_TAG }}';

          // 1) Try to use the body from the latest draft release (Release Drafter)
          try {
            const releases = await github.rest.repos.listReleases({
              owner,
              repo,
              per_page: 20,
            });

            if (releases.data && releases.data.length > 0) {
              const draft = releases.data.find(r => r.draft);

              if (draft) {
                core.info(`Found draft release: ${draft.name || draft.tag_name} (ID: ${draft.id})`);
                const draftBody = draft.body || '';
                core.info('Using draft release body as release notes:');
                core.info(draftBody);
                return draftBody;
              }
            }
          } catch (error) {
            core.warning(`Failed to read draft release from Release Drafter: ${error.message}`);
          }

          // 2) Fallback: use GitHub auto-generated release notes for this tag
          core.info('No draft release found. Falling back to GitHub generated release notes.');
          const response = await github.rest.repos.generateReleaseNotes({
            owner,
            repo,
            tag_name: tagName,
          });

          const body = response.data.body || '';
          core.info('Generated release notes from GitHub:');
          core.info(body);
          return body;

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ needs.build.outputs.RELEASE_TAG }}
        name: Release ${{ needs.build.outputs.RELEASE_TAG }}
        files: release-assets/*.exe
        body: ${{ steps.notes.outputs.result }}
        generate_release_notes: false
        prerelease: ${{ needs.build.outputs.IS_PRERELEASE == 'true' }}
